# Mask Crop by BBox Mask - 依据 BBox 裁切遮罩

**节点功能：** `Mask Crop by BBox Mask` 使用 `bbox_mask` 提取的边界框对 `mask` 进行裁切。支持批次循环、进度上报，并在需要时将输出遮罩填充到统一尺寸以便堆叠。

## 输入

| 参数名称 | 入端选择 | 数据类型 | 默认值 | 取值范围 | 描述 |
| -------- | -------- | -------- | ------ | -------- | ---- |
| `mask` | - | MASK | - | - | 源遮罩批次；二维输入会扩展到 `[B,H,W]` |
| `bbox_mask` | - | MASK | - | - | 定义裁切边界框的遮罩；二维输入同样扩展 |

## 输出

| 输出名称 | 数据类型 | 描述 |
|---------|----------|------|
| `cropped_mask` | MASK | 裁切后的遮罩批次；若尺寸不一致会统一填充后再堆叠 |

## 功能说明

- 边界框检测：以阈值 `>10`（`[0..255]`）从 `bbox_mask` 提取 bbox。
- 批次循环：当批次不一致时使用 `bbox_mask[b % bbox_batch]` 对齐。
- 进度事件：通过 `PromptServer` 结合唯一节点 ID 上报进度。
- 安全裁切：约束 bbox 于图像边界内，使用 PIL 裁切并返回 `[0,1]` 浮点遮罩。
- 统一堆叠：若批次内尺寸不同，则先补齐到最大尺寸再 `stack`。

## 典型用法

- ROI 提取：用已有的 bbox 限定遮罩的关注区域。
- 工作流配合：由图像裁切节点生成 bbox，再用该节点对遮罩区域进行精确裁切。

## 注意与建议

- 当 `bbox_mask` 无非零区域时，该条目返回原始 `mask` 不变。
- bbox 阈值（`>10`）可抑制椒盐噪点；建议在上游保证遮罩质量以获得稳健 bbox。