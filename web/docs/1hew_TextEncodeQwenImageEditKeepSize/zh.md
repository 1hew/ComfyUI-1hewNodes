# Text Encode QwenImageEdit Keep Size - 视觉语言条件编码与尺寸策略

**节点功能：** `Text Encode QwenImageEdit Keep Size` 将文本提示与一张或多张图像共同编码为适配 QwenImageEdit 的条件。每张图像都会生成固定 `384×384` 的视觉标记流；可选地按尺寸策略生成并附加 VAE 参考潜空间，从而在编辑中保留构图与语义。

## 输入

| 参数名称 | 入端选择 | 数据类型 | 默认值 | 取值范围 | 描述 |
| -------- | -------- | -------- | ------ | -------- | ---- |
| `clip` | - | CLIP | - | - | 支持视觉标记与计划编码的 CLIP 模型。 |
| `prompt` | - | STRING | `` | 多行 | 文本指令，会在图像视觉标记之后拼接并采用兼容模板包装。 |
| `keep_size` | - | COMBO | `first` | `none` / `first` / `all` | VAE 参考潜空间尺寸策略：`none` 全部按目标面积缩放；`first` 保留首图在满足 8 倍数条件时的原始尺寸；`all` 保留所有满足 8 倍数条件的图像尺寸。 |
| `base_size` | - | COMBO | `1024` | `1024` / `1536` / `2048` | 目标面积边长；当不保留尺寸或输入尺寸不满足 8 倍数时，按 `base_size²` 面积等比缩放并将宽高四舍五入到 8 的倍数。 |
| `vae` | 可选 | VAE | - | - | 用于编码 RGB 参考潜空间，并附加到条件中。 |
| `image_1` | 可选 | IMAGE | - | - | 第一张图像；用于生成视觉标记并可能产生参考潜空间。 |
| `image_2…image_N` | 可选 | IMAGE | - | - | 通过数字后缀识别的额外图像，按后缀排序；建议最多 10 张。 |

## 输出

| 输出名称 | 数据类型 | 描述 |
|---------|----------|------|
| `conditioning` | CONDITIONING | 适配 QwenImageEdit 的条件；当生成参考潜空间时会附加 `reference_latents`。 |

## 功能说明

- 视觉标记固定为 384×384：每张图像以 `area` 重采样到 `384×384`，在 CLIP 分词时与文本共同编码，文本采用 Qwen 兼容的模板包装视觉占位符与系统段。
- 尺寸保留与统一：`keep_size` 控制参考潜空间的尺寸保留与统一；在满足 8 倍数条件时保留原始空间，否则按 `base_size²` 目标面积等比缩放并对宽高取 8 的倍数。
- RGB 通道潜空间：参考潜空间从 RGB 通道编码；保持编辑语义一致性。
- 动态有序输入：通过 `image_1`、`image_2`… 的数字后缀收集并按后缀排序，确保多图指导顺序稳定。
- 计划式编码：分词结果经 CLIP 的计划式编码；参考潜空间以 `reference_latents` 附加供下游使用。

## 典型用法

- 锚定式编辑：提供一张或多张锚图，设置 `keep_size=first` 保留首张锚图（已满足 8 倍数）以稳定构图。
- 全部保留：设置 `keep_size=all` 保留全部满足 8 倍数的原始尺寸；其他图像按所选 `base_size` 统一面积。
- 统一潜空间面积：设置 `keep_size=none` 并选择 `base_size=1536/2048`，获得一致的参考潜空间尺度以提升模型稳定性。
- 纯文本条件：省略图像仅编码文本；在需要时追加图像丰富引导。

## 注意与建议

- 8 倍数约束：保留原尺寸时要求宽高均为 8 的倍数；否则将按选定 `base_size²` 面积等比缩放并对宽高取 8 的倍数。
- 通道处理：参考潜空间使用 RGB；视觉标记基于重采样的输入图像生成。
- 输入收集：通过 `image_*` 的数字后缀识别并按升序排列；可跳过部分编号。
- 设备与类型：保持张量的 dtype/设备一致；支持批处理，默认采用末通道布局（`B×H×W×C`）。