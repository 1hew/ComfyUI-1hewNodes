# Detect Yolo - YOLO 目标检测（遮罩与标注）

**节点功能：** `Detect Yolo` 使用 Ultralytics YOLO 模型进行目标检测。在图像上绘制边框与可选标签，并从实例遮罩聚合生成二值遮罩（若模型未提供遮罩，则回退为基于 bbox 的遮罩）。

## 输入

| 参数名称 | 入端选择 | 数据类型 | 默认值 | 取值范围 | 描述 |
| -------- | -------- | -------- | ------ | -------- | ---- |
| `image` | - | IMAGE | - | - | 输入图像批次 |
| `yolo_model` | - | COMBO | 模型列表 | .pt 文件 | 模型选择；列出 `models/yolo` 下的 `.pt` 文件；也可填写相对路径 |
| `threshold` | - | FLOAT | 0.3 | 0.0-1.0 | 置信度阈值（`conf`） |
| `mask_index` | - | STRING | `-1` | 逗号列表 | 选择参与聚合的检测索引；`-1` 表示全部；支持中/英文逗号 |
| `label` | - | BOOLEAN | `True` | - | 是否绘制标签 |
| `label_size` | - | FLOAT | 1.0 | 0.1-5.0 | 标签缩放，影响字体与边框粗细 |

## 输出

| 输出名称 | 数据类型 | 描述 |
|---------|----------|------|
| `plot_image` | IMAGE | 带边框与可选标签的标注图像 |
| `mask` | MASK | 聚合后的二值遮罩（`B×H×W`，范围 `[0,1]`） |

## 功能说明

- 模型缓存：按路径缓存已加载的 YOLO 模型，避免重复初始化。
- 遮罩聚合：按选择索引求和并限制在 `[0,1]`；当无分割遮罩时回退为 bbox 区域遮罩。
- 标签绘制：绘制 `[index] class conf` 文本，带背景填充，`label_size` 可调。
- 路径发现：优先 ComfyUI `models/yolo`，其次 base 路径；若均无则在当前目录创建 `models/yolo`。
- 批量异步：逐帧推理在工作线程执行，串行访问模型。

## 典型用法

- 将 `.pt` 模型放置到 `models/yolo`（如 `yolov8n-seg.pt`），在下拉框选择。
- 设置 `threshold` 控制检测强度；`mask_index=-1` 聚合全部遮罩，或指定 `0,1` 等索引。
- 通过 `label_size` 调整显示；或将 `label=False` 以仅输出遮罩。

## 注意与建议

- 当模型未返回遮罩时，会基于 bbox 生成二值遮罩。
- `mask_index` 按检测顺序解析，越界索引会被忽略。
- 节点会输出简洁日志，便于定位问题。